<!DOCTYPE html>
<html>
<head>
	<title>Difoosion Chat</title>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script>
		$(document).ready(function() {
			var lastRequest = 0;
			var userId = 0;
			var connected = false;
			var loading = false;
			var fails = 0;
			var sendMessage = function() {
				var message = $("#message").val();
				if (message != "") {
					$.ajax({
						type: "POST",
						url: "SendMessage",
						data: { message: message, userId : userId }
					}).done(function( msg ) {
						loadMessages();
					});
					$("#message").val("");
				}
			};
			
			var loadMessages = function() {
				if (connected && !loading) {
					loading = true;
					$.ajax({
						type: "POST",
						url: "NewMessages",
						data: { timestamp: lastRequest, userId: userId }
					}).done(function( response ) {
						fails = 0;
						loading = false;
						lastRequest = response.timestamp;
						var messages = response.messages;
						var message = undefined;
						var html = "";
						jQuery.each(messages, function() {
							var timestamp = new Date(this.timestamp);
							var time = timestamp.getHours().toString() + ":" + timestamp.getMinutes().toString() + ":" + timestamp.getSeconds().toString();
							html += '<li>' + time + ": (" + this.name + ") " + this.message + '</li>';
						});
						$('#messages').append(html);
						var messagesDiv = document.getElementById("messages");
						messagesDiv.scrollTop = messagesDiv.scrollHeight;
					}).fail(function() {
						fails = fails + 1;
						if (fails == 3) {
							fails = 0;
							loading = false;
							connected = false;
							$(".user").show();
							$(".message_box").hide();
							alert("El chat se ha desconectado");
						}
					});
				}
			};
			
			$("#message").keypress(function(e)
			{
				code = (e.keyCode ? e.keyCode : e.which);
				if (code == 13) {
					sendMessage();
					e.preventDefault();
				}
			});
			
			$("#username").keypress(function(e)
			{
				code = (e.keyCode ? e.keyCode : e.which);
				if (code == 13) {
					changeUserName();
					e.preventDefault();
				}
			});
			
			    
			var createCookie = function (name,value,days) {
				if (days) {
					var date = new Date();
					date.setTime(date.getTime()+(days*24*60*60*1000));
					var expires = "; expires="+date.toGMTString();
				}
				else var expires = "";
				document.cookie = name+"="+value+expires+"; path=/";
			};
			
			var readCookie = function (name) {
				var nameEQ = name + "=";
				var ca = document.cookie.split(';');
				for(var i=0;i < ca.length;i++) {
					var c = ca[i];
					while (c.charAt(0)==' ') c = c.substring(1,c.length);
					if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
				}
				return null;
			};
    
			var hideUser = function() {
				$(".user").hide();
				$(".message_box").show();
			};
			
			var changeUserName = function() {
				var name = $("#username").val();
				$.ajax({
					type: "POST",
					url: "Register",
					data: { name: name }
				}).done(function( response ) {
					if (typeof response === "undefined") {

					}
					else {
						var result = eval("(" + response + ")");
						userId = result.id;
						createCookie("userId", userId, 1);
						createCookie("name", name, 1);
						hideUser();
						connected = true;
						loadMessages();
					}
				}).fail(function() {
					alert("Ese usuario ya se está usado");
				});
				$("#message").val("");
			};
			
			var loadUser = function() {
				userId = readCookie("userId");
				var name = readCookie("name");
				if (typeof userId === "undefined") {
				
				}
				else {					
					$.ajax({
						type: "POST",
						url: "CheckUser",
						data: { name: name, userId : userId }
					}).done(function( response ) {
						if (typeof response === "undefined") {
						
						}
						else {
							var result = eval("(" + response + ")");
							userId = result.id;
							createCookie("userId", userId, 1);
							connected = true;
							loadMessages();
							hideUser();
						}
					});
				}
			};
			window.setInterval(loadMessages, 2500);
			loadUser();
		});
	</script>
	<style>
		body { margin: 0; background-image:url('bg.jpg'); font-family: 'Open Sans', sans-serif; font-size: 11pt }
		h1 { color: #543A59; margin: 0 }
		.container { width: 640px; margin: 0 auto }
		.container_inner { width: 640px; position: fixed; bottom: 0; padding: 10px; background-color: #fff; box-shadow: rgba(255, 255, 255, 0.2) 4px 2px 6px }
		.chat ul { list-style-type: none; padding: 0; height: 320px; overflow:auto }
		.message_box { margin: 2px auto }
		.message_box input { width: 100% }
		.powered_by_nodejs { position: fixed; margin: 10px; bottom: 0px; right: 0px } 
		.powered_by_nodejs img { border: 0}
		.difoosion_logo { position: fixed; margin: 10px; bottom: 0px; left: 0px } 
		.difoosion_logo img { border: 0}
	</style>
</head>
<body>
	<div class="container">
		<div class="container_inner">
			<h1>Difoosion Room</h1>

			<div class="user">
				Nombre: <input type="text" id="username" />
			</div>
			
			<div class="chat">
				<ul id="messages">
					
				</ul>
			</div>
				
			<div class="message_box" style="display: none">
				<input type="text" id="message" />
			</div>
			
			<div class="difoosion_logo">
				<a href="http://difoosion.com" target="blank">
					<img src="difoosion-logo.png" />
				</a>
			</div>
			
			<div class="powered_by_nodejs">
				<a href="http://nodejs.org" target="blank">
					<img src="nodejs-logo.png" />
				</a>
			</div>
		</div>
	</div>
</body>